# 豆瓣 API 使用文档 (LibreTV 功能增强指南)

## 引言

本文档旨在总结当前可稳定使用的豆瓣 API 接口，并探讨如何利用这些接口来增强 LibreTV 的功能，帮助用户通过更多维度（如类型、地区、热度、评分等）发现他们感兴趣的电影和电视剧。

## 一、经验证可用的 API 接口 (主要基于 `movie.douban.com/j/`)

经过测试，以下接口目前无需 API Key 且相对稳定可用：

### 1. 获取分类标签 (Fetch Tags/Categories)

-   **接口地址:** `GET https://movie.douban.com/j/search_tags`
-   **功能描述:** 获取电影或电视剧的可用分类标签列表（如类型、地区等）。
-   **主要参数:**
    -   `type` (必需): `movie` (电影) 或 `tv` (电视剧)。
-   **请求示例 (cURL):**
    ```bash
    curl "https://movie.douban.com/j/search_tags?type=movie" \
      -H "User-Agent: Mozilla/5.0" \
      -H "Referer: https://movie.douban.com/"
    ```
-   **返回示例:**
    ```json
    {
      "tags": ["热门", "最新", "经典", "豆瓣高分", "冷门佳片", "华语", "欧美", "韩国", "日本", "动作", "喜剧", "爱情", "科幻", "悬疑", "恐怖", "治愈"]
    }
    ```
-   **LibreTV 应用:**
    -   获取电影和电视剧的官方分类标签，用于构建分类浏览菜单。
    -   用户可以选择这些标签（如“喜剧”、“科幻”、“国产剧”）来筛选内容。

### 2. 按标签获取影视列表 (Fetch Subjects by Tag)

-   **接口地址:** `GET https://movie.douban.com/j/search_subjects`
-   **功能描述:** 根据指定的类型、标签和排序方式，获取电影或电视剧的列表。
-   **主要参数:**
    -   `type` (必需): `movie` (电影) 或 `tv` (电视剧)。
    -   `tag` (必需): 标签名，需要 URL编码 (例如, "热门" 编码为 `%E7%83%AD%E9%97%A8`)。虽然 `/j/search_tags` 提供了一个官方标签列表，但此接口在实践中也接受许多未在 `search_tags` 输出中列出的常用标签。基于测试，支持的标签包括但不限于：
        -   **类型 (Types):** 喜剧, 爱情, 动作, 科幻, 动画, 悬疑, 犯罪, 惊悚, 冒险, 音乐, 历史, 奇幻, 恐怖, 战争, 传记, 歌舞, 武侠, 情色, 灾难, 西部, 纪录片, 短片.
        -   **地区 (Regions):** 华语, 欧美, 韩国, 日本, 中国大陆, 美国, 中国香港, 中国台湾, 英国, 法国, 德国, 意大利, 西班牙, 印度, 泰国, 俄罗斯, 加拿大, 澳大利亚, 爱尔兰, 瑞典, 巴西, 丹麦.
        -   **描述性标签 (Descriptive Tags):** 如 "文艺", "经典", "热门", "最新", "豆瓣高分", "冷门佳片". (注意: "热门", "最新", "经典", "豆瓣高分", "冷门佳片" 等通常也由 `/j/search_tags` 返回)
        -   **局限:** 此参数不支持特定年份 (如 "2023") 或年代范围 (如 "2020年代", "90年代") 作为标签进行筛选。对于年代，可使用 "最新"、"经典" 等标签，或结合 `sort=time` 参数。
    -   `sort` (可选): 排序方式。常用值：
        -   `recommend`: 按综合推荐/热度排序。
        -   `time`: 按上映/播出时间排序 (最新)。
        -   `rank`: 按评分排序。
    -   `page_limit` (可选): 每页返回的项目数量，默认为 20。
    -   `page_start` (可选): 分页起始位置，默认为 0。
-   **请求示例 (cURL - 获取热门电影，按推荐排序，每页2条):**
    ```bash
    curl "https://movie.douban.com/j/search_subjects?type=movie&tag=%E7%83%AD%E9%97%A8&sort=recommend&page_limit=2&page_start=0" \
      -H "User-Agent: Mozilla/5.0" \
      -H "Referer: https://movie.douban.com/"
    ```
-   **返回示例 (部分):**
    ```json
    {
      "subjects": [
        {
          "rate": "7.1", "title": "战·争", "url": "https://movie.douban.com/subject/36776989/",
          "cover": "https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2918622737.jpg", "id": "36776989", ...
        },
        {
          "rate": "7.2", "title": "丑陋的继姐", "url": "https://movie.douban.com/subject/36471252/",
          "cover": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2919977751.jpg", "id": "36471252", ...
        }
      ]
    }
    ```
-   **LibreTV 应用:**
    -   核心功能：根据用户选择的类型标签（如“喜剧”）、地区标签（如“华语”）展示相应的影视列表。
-   实现按热度、评分、最新时间排序的功能。
-   实现分页加载。

### 3. 新版筛选接口 (Fetch Subjects by Multiple Criteria - New API)

-   **接口地址:** `GET https://movie.douban.com/j/new_search_subjects`
-   **功能描述:** 根据多种筛选条件（内容类型、题材、地区、排序方式、评分范围等）获取电影或电视剧的列表。这是目前 LibreTV 高级筛选功能和部分首页内容推荐所依赖的主要接口。
-   **主要参数 (根据 LibreTV 当前使用情况):**
    -   `tags` (可选): 主要用于指定大的内容分类，如 "电影", "电视剧", "动画", "综艺", "纪录片", "短片"。如果为空，则可能代表所有类型。
    -   `genres` (可选): 指定题材/类型，可为单个值或多个值以逗号分隔 (URL编码，如 "科幻,喜剧")。例如："科幻", "喜剧", "动作"。
    -   `countries` (可选): 指定制片国家/地区，可为单个值或多个值以逗号分隔 (URL编码)。例如："中国大陆", "美国", "日本"。
    -   `sort` (可选): 排序方式。
        -   `T`: 按热度/综合推荐排序。
        -   `R`: 按时间排序 (最新)。
        -   `S`: 按评分排序。
    -   `start` (可选): 分页起始位置 (结果的索引)，默认为 0。
    -   `range` (可选): 指定评分范围，格式为 `min,max` (例如, "0,10" 或 "7,10")。LibreTV 首页部分板块固定使用 "0,10"。
    -   *注意:* 此接口通常每页返回固定数量的结果 (如20条)，`page_limit` 参数似乎不直接适用或由 `range` 间接影响。
-   **请求示例 (cURL - 获取评分在7-10之间的科幻电影，按热度排序):**
    ```bash
    curl "https://movie.douban.com/j/new_search_subjects?tags=%E7%94%B5%E5%BD%B1&genres=%E7%A7%91%E5%B9%BB&sort=T&range=7,10&start=0" \
      -H "User-Agent: Mozilla/5.0" \
      -H "Referer: https://movie.douban.com/"
    ```
-   **返回示例 (部分，数据在 `data` 字段下):**
    ```json
    {
      "data": [
        {
          "directors": ["克里斯托弗·诺兰"], "rate": "9.4", "title": "盗梦空间", "casts": ["莱昂纳多·迪卡普里奥", ...],
          "cover": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p513344864.jpg", "id": "3541415", ...
        },
        {
          "directors": ["丹尼斯·维伦纽瓦"], "rate": "8.5", "title": "沙丘", "casts": ["蒂莫西·柴勒梅德", ...],
          "cover": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2677337033.jpg", "id": "3001114", ...
        }
      ]
    }
    ```
-   **LibreTV 应用:**
    -   **筛选页面:** 作为筛选功能的核心，允许用户组合选择内容类型、题材、地区、排序方式来查找影视。
    -   **首页内容推荐:** 部分首页的瀑布流板块（如“热门综艺”、“热门动画”、“科幻电影”等）使用此接口获取数据。
    -   实现分页加载。

### 4. 获取分类排行榜 (Fetch Top List by Genre - Chart API)

-   **接口地址:** `GET https://movie.douban.com/j/chart/top_list`
-   **功能描述:** 获取特定分类下的影视排行榜列表。
-   **主要参数:**
    -   `type` (必需): 所属分类的数字ID。根据提供的信息，ID及其对应类型如下：
        -   剧情 - 11
        -   喜剧 - 24
        -   动作 - 5
        -   爱情 - 13
        -   科幻 - 17
        -   动画 - 25
        -   悬疑 - 10
        -   惊悚 - 19
        -   恐怖 - 20
        -   纪录片 - 1
        -   短片 - 23
        -   情色 - 6
        -   同性 - 26
        -   音乐 - 14
        -   歌舞 - 7
        -   家庭 - 28
        -   儿童 - 8
        -   传记 - 2
        -   历史 - 4
        -   战争 - 22
        -   犯罪 - 3
        -   西部 - 27
        -   奇幻 - 16
        -   冒险 - 15
        -   灾难 - 12
        -   武侠 - 29
        -   古装 - 30
        -   运动 - 18
        -   黑色电影 - 31
        -   *(注意: 似乎没有 9 和 21)*
    -   `interval_id` (必需): 时间区间和百分比，例如 `100:90` (可能代表最近100天内，评分在前90%的影片)。具体含义需进一步探索，但可作为固定值使用。
    -   `action` (可选): 功能未知，示例中为空。可默认为空。
    -   `start` (可选): 分页起始位置，默认为 0。
    -   `limit` (可选): 每页返回的项目数量，默认为 20。
-   **请求示例 (cURL - 获取剧情片排行榜，前20条):**
    ```bash
    curl "https://movie.douban.com/j/chart/top_list?type=11&interval_id=100:90&action=&start=0&limit=20" \
      -H "User-Agent: Mozilla/5.0" \
      -H "Referer: https://movie.douban.com/"
    ```
-   **返回示例 (结构与 `/j/search_subjects` 类似，但通常不包含 `total` 字段):**
    ```json
    [ // 注意：此接口直接返回一个数组，而不是包含 subjects 键的对象
      {
        "rating": ["4.5", "90"], "rank": 1, "cover_url": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2629197069.jpg",
        "is_playable": true, "id": "26794435", "types": ["剧情", "喜剧"], "regions": ["中国大陆"],
        "title": "我和我的家乡", "url": "https://movie.douban.com/subject/26794435/", "release_date": "2020-10-01",
        "actor_count": 30, "vote_count": 661968, "score": "9.0", "actors": ["葛优", "黄渤", ...], "is_watched": false
      },
      // ... more items
    ]
    ```
-   **LibreTV 应用:**
    -   **首页内容推荐:** 可以为首页创建不同类型的“排行榜”板块，如“剧情片榜”、“喜剧片榜”等。
    -   **筛选页面:** 可以作为一种新的数据源或排序方式，例如在选择“剧情”分类后，提供一个“排行榜”的查看选项。
    -   需要将界面上用户选择的文本类型（如“剧情”）映射到此API所需的数字 `type` ID。

### 5. 搜索建议 (Search Suggestions)

-   **接口地址:** `GET https://movie.douban.com/j/subject_suggest?q={query}`
-   **功能描述:** 根据用户输入的关键词，提供影视条目搜索建议。
-   **主要参数:**
    -   `q` (必需): 用户输入的搜索关键词，需要 URL编码。
-   **请求示例 (cURL - 搜索 "红楼梦"):**
    ```bash
    curl "https://movie.douban.com/j/subject_suggest?q=%E7%BA%A2%E6%A5%BC%E6%A2%A6" \
      -H "User-Agent: Mozilla/5.0" \
      -H "Referer: https://movie.douban.com/"
    ```
-   **返回示例 (部分):**
    ```json
    [
      {"img": "...", "title": "红楼梦", "url": "...", "type": "movie", "year": "1987", "id": "1864810"},
      {"img": "...", "title": "红楼梦", "url": "...", "type": "movie", "year": "2010", "id": "3014183"}
    ]
    ```
-   **LibreTV 应用:**
    -   为应用的搜索框提供实时搜索建议，提升用户体验。
    -   用户点击建议后，可以获取到影视的 `id`，但后续需要其他接口（目前受限）来获取该 `id` 的详细信息，或尝试使用标题进行进一步的（可能不精确的）搜索。

## 二、如何利用上述 API 增强 LibreTV 功能

结合以上四个经验证可用的 API，LibreTV 可以实现以下核心的发现功能：

1.  **按类型/题材浏览:**
    -   **实现:** 首先调用 `/j/search_tags` 获取所有电影和电视剧的类型标签（如“剧情”、“喜剧”、“科幻”等）。将这些标签展示给用户。当用户选择一个标签后，调用 `/j/search_subjects` 并传入该标签名和对应的 `type` (movie/tv) 来获取该类型下的影视列表。
    -   **效果:** 用户可以方便地找到特定类型的电影或电视剧。

2.  **按地区浏览:**
    -   **实现:** `/j/search_tags` 返回的标签中通常包含一些地区相关的标签，如“华语”、“欧美”、“韩国”、“日本”等。LibreTV 可以将这些作为地区筛选条件。
    -   **效果:** 用户可以筛选特定国家或地区的影片。
    -   **注意:** 这种方式提供的地区分类比较宽泛，可能无法满足非常精细的国别筛选需求。

3.  **按热度、评分、最新时间排序:**
    -   **实现:** 在调用 `/j/search_subjects` 时，根据用户的选择，在 `sort` 参数中传入 `recommend` (热度)、`rank` (评分) 或 `time` (最新)。
    -   **效果:** 用户可以在特定分类下，按自己关心的维度对影片进行排序和发现。

4.  **基本搜索功能:**
    -   **实现:** 用户在搜索框输入时，调用 `/j/subject_suggest` 获取建议列表。用户选择某个建议后，应用可以记录其标题或ID。
    -   **效果:** 提供基础的影视名称搜索入口。
    -   **局限:** `/j/subject_suggest` 返回的信息有限。要获取选中条目的详细信息（如演员、导演、剧情简介），理想情况下需要一个根据ID获取详情的接口，但这部分接口目前受限（见下文）。

## 三、当前可用 API 的局限性及对高级功能的影响

虽然上述 `/j/` 系列接口提供了一些基础的浏览和搜索能力，但对于实现更高级、多维度的筛选功能（如按特定导演、演员搜索）存在以下主要局限：

1.  **无法直接按导演/演员筛选 (使用 `/j/` 系列接口):**
    -   `/j/search_subjects` 接口的 `tag` 参数主要接受类型、地区等预设标签，**不直接支持传入导演或演员名进行精确筛选**。
    -   `/j/subject_suggest` 接口虽然可以接受演员/导演名作为搜索词 `q`，但其返回的是建议列表，并非直接的影视作品列表，且信息有限。
    -   这意味着 LibreTV **无法仅通过这些已验证且易于使用的 `/j/` 接口** 实现“查找某位导演的所有电影”或“查找某位演员参演的电视剧”这类功能。

2.  **无法获取详细的影视信息 (如演职员表、完整剧情，使用 `/j/` 系列接口):**
    -   `/j/search_subjects` 返回的列表中，每个条目仅包含标题、评分、封面、ID等基本信息，**不包含导演、演员列表、详细剧情简介、具体国家、语言等元数据**。
    -   这使得在获取列表后进行客户端的二次筛选（例如，筛选出某导演的作品）变得不可能。

3.  **多维度组合筛选困难:**
    -   由于 `/j/search_subjects` 主要依赖单一 `tag` 进行筛选，实现复杂的组合条件（如“周星驰主演的90年代香港喜剧电影”）非常困难。

## 四、关于其他豆瓣 API (目前无法稳定使用)

豆瓣确实存在其他更强大的 API 接口，例如：

-   **`https://api.douban.com/v2/` 系列 (需要有效 API Key):**
    -   如 `/v2/movie/subject/:id` (获取电影详情)、`/v2/movie/celebrity/:id` (获取影人详情，其返回的 `works` 字段包含作品列表)、`/v2/movie/search` (更强大的搜索功能，理论上 `q` 参数可用于搜索演员/导演名)。
    -   **现状:** 这些接口通常需要 `apikey`。经过测试，目前公开流传的 `apikey` (如 `0b2bdeda43b5688921839c8ecb20399b`, `0df993c66c0c636e29ecbb5344252a4a`) 大多已被封禁。没有有效的、未被封禁的 `apikey`，这些接口无法使用。因此，通过这些接口按演员/导演搜索的功能当前不可行。

-   **`https://m.douban.com/rexxar/api/v2/` 系列 (调用复杂):**
    -   这是豆瓣移动端使用的接口，数据丰富。
    -   **现状:** 直接调用这些接口较为复杂，通常需要模拟移动应用的请求环境（特定的 User-Agent、Cookies、其他 Headers 等），且接口行为可能随时调整，稳定性难以保证。简单测试表明直接访问会失败。

**如果未来能够获得有效的 `apikey` 或找到稳定调用 `rexxar` 系列接口的方法，LibreTV 的功能将可以得到极大扩展，包括：**
-   精确的导演、演员搜索和筛选。
-   展示详细的影视信息页面。
-   实现更丰富的多维度推荐。

## 五、总结与建议

对于 LibreTV 当前阶段，建议充分利用 `https://movie.douban.com/j/` 系列的四个已验证接口：

-   **核心功能:** 实现按类型、地区（基于已有标签）、热度、评分、最新时间的浏览和排序。
-   **搜索:** 提供基于影视名称的搜索建议。
-   **用户引导:** 在界面上明确告知用户当前搜索和筛选能力的范围，管理用户预期。

持续关注是否有新的、更开放的豆瓣 API 策略或社区发现的稳定调用方法，以便未来引入更强大的影视发现功能。
